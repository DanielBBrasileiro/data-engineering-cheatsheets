<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python __main__ & Execution Cheatsheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; -webkit-print-color-adjust: exact; }
        code { font-family: 'JetBrains Mono', monospace; }
        
        @media print {
            body { background: white; margin: 0; padding: 0; font-size: 11px; }
            .container { max-width: 100% !important; margin: 0; padding: 0.5cm; }
            .no-print { display: none; }
            .card { break-inside: avoid; border: 1px solid #ccc; box-shadow: none; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <div class="max-w-6xl mx-auto container bg-white shadow-xl min-h-screen p-6 md:p-8 rounded-lg">
        
        <!-- Header -->
        <header class="border-b-4 border-yellow-500 pb-4 mb-6 flex justify-between items-start">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 tracking-tight">Python <span class="text-yellow-600">__main__</span></h1>
                <p class="text-sm md:text-base text-gray-600 mt-1 font-medium">Top-Level Execution ‚Ä¢ Entry Points ‚Ä¢ -m Switch ‚Ä¢ Packaging</p>
            </div>
            <div class="flex gap-2 text-xs font-bold uppercase tracking-wider">
                <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Core</span>
                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">Scripting</span>
                <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded">CLI</span>
            </div>
        </header>

        <!-- Grid Layout -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <!-- COLUMN 1: The Guard & Patterns -->
            <div class="space-y-6">
                
                <!-- THE NAME GUARD -->
                <section class="card bg-white border rounded-lg overflow-hidden ring-2 ring-yellow-100">
                    <div class="bg-yellow-600 text-white px-4 py-2 flex justify-between items-center">
                        <h2 class="font-bold text-sm uppercase">1. O Guardi√£o (The Guard)</h2>
                        <span class="text-xs bg-yellow-700 px-2 rounded">Mandat√≥rio</span>
                    </div>
                    <div class="p-4 space-y-3">
                        <div class="bg-slate-100 p-3 rounded text-xs text-gray-700 border-l-4 border-slate-500 mb-2">
                            <strong>Conceito:</strong> Quando o Python l√™ um arquivo, ele executa <em>todo</em> o c√≥digo top-level. O <code>if __name__</code> previne execu√ß√£o indesejada ao importar o m√≥dulo.
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 text-xs">
                            <div>
                                <h3 class="font-bold text-gray-900 mb-1">Como Script</h3>
                                <code>python script.py</code>
                                <p class="text-gray-500 mt-1">__name__ vale <code>"__main__"</code>. O bloco roda.</p>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900 mb-1">Como M√≥dulo</h3>
                                <code>import script</code>
                                <p class="text-gray-500 mt-1">__name__ vale <code>"script"</code>. O bloco √© ignorado.</p>
                            </div>
                        </div>

                        <pre><code class="language-python"># etl_job.py

print("Eu rodo sempre (cuidado!)") # ‚ùå Side effect no import

def run_pipeline():
    print("Processando dados...")

if __name__ == "__main__":
    # S√≥ roda se for o entry point
    print("Iniciando execu√ß√£o manual...")
    run_pipeline()</code></pre>
                    </div>
                </section>

                <!-- STANDARD PATTERN -->
                <section class="card bg-white border rounded-lg overflow-hidden">
                    <div class="bg-slate-800 text-white px-4 py-2 flex justify-between items-center">
                        <h2 class="font-bold text-sm uppercase">2. O Padr√£o main()</h2>
                        <span class="text-xs bg-slate-700 px-2 rounded">Best Practice</span>
                    </div>
                    <div class="p-4 space-y-3">
                        <p class="text-xs text-gray-600 mb-1">Encapsule l√≥gica em <code>main()</code> e retorne c√≥digos de sa√≠da para o SO (√∫til para Airflow/Kubernetes detectarem falhas).</p>
                        <pre><code class="language-python">import sys

def main(args):
    try:
        # L√≥gica principal aqui
        return 0 # Sucesso
    except Exception as e:
        print(f"Erro fatal: {e}", file=sys.stderr)
        return 1 # Erro

if __name__ == "__main__":
    # Passa argumentos do CLI e sai com status code
    sys.exit(main(sys.argv[1:]))</code></pre>
                    </div>
                </section>

                <!-- MULTIPROCESSING CONTEXT -->
                <section class="card bg-white border rounded-lg overflow-hidden">
                    <div class="bg-slate-800 text-white px-4 py-2 flex justify-between items-center">
                        <h2 class="font-bold text-sm uppercase">3. Multiprocessing Safety</h2>
                        <span class="text-xs bg-slate-700 px-2 rounded">Windows/Mac</span>
                    </div>
                    <div class="p-4 space-y-3">
                        <p class="text-xs text-gray-600 mb-1">No m√©todo <code>spawn</code> (padr√£o Mac/Win), o Python importa o script novamente em cada processo filho. Sem o guardi√£o, voc√™ cria um loop infinito de processos (Fork Bomb).</p>
                        <pre><code class="language-python">from multiprocessing import Process

def worker(): pass

# SEM O IF __NAME__:
# O filho importa esse arquivo -> Cria novo processo -> ...
p = Process(target=worker) 
p.start() # üí• RecursionError / Crash</code></pre>
                    </div>
                </section>

            </div>

            <!-- COLUMN 2: Packaging & execution Modes -->
            <div class="space-y-6">

                <!-- SCRIPT VS MODULE -->
                <section class="card bg-white border rounded-lg overflow-hidden">
                    <div class="bg-slate-800 text-white px-4 py-2 flex justify-between items-center">
                        <h2 class="font-bold text-sm uppercase">4. Script vs Module (-m)</h2>
                        <span class="text-xs bg-slate-700 px-2 rounded">Imports</span>
                    </div>
                    <div class="p-4 space-y-3">
                        <p class="text-xs text-gray-600 mb-1">A forma como voc√™ chama o Python muda o <code>sys.path</code> e como imports relativos funcionam.</p>
                        
                        <table class="w-full text-xs text-left mb-2">
                            <thead class="bg-gray-100 font-bold text-gray-700">
                                <tr><th class="p-2">Comando</th><th class="p-2">sys.path[0]</th><th class="p-2">Imports Relativos</th></tr>
                            </thead>
                            <tbody class="divide-y">
                                <tr>
                                    <td class="p-2 font-mono">python mypkg/app.py</td>
                                    <td class="p-2"><code>mypkg/</code></td>
                                    <td class="p-2 text-red-600">‚ùå Quebra (<code>from . import utils</code> falha)</td>
                                </tr>
                                <tr>
                                    <td class="p-2 font-mono bg-green-50">python -m mypkg.app</td>
                                    <td class="p-2 bg-green-50"><code>$PWD</code> (Atual)</td>
                                    <td class="p-2 text-green-600 bg-green-50">‚úÖ Funcionam</td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="bg-blue-50 p-2 rounded text-xs border-l-4 border-blue-500">
                            <strong>Dica Data Engineer:</strong> Em pipelines complexos, prefira sempre rodar com <code>python -m</code> a partir da raiz do projeto para evitar erros de <code>ModuleNotFound</code>.
                        </div>
                    </div>
                </section>

                <!-- EXECUTABLE PACKAGES -->
                <section class="card bg-white border rounded-lg overflow-hidden">
                    <div class="bg-slate-800 text-white px-4 py-2 flex justify-between items-center">
                        <h2 class="font-bold text-sm uppercase">5. Executable Packages (__main__.py)</h2>
                        <span class="text-xs bg-slate-700 px-2 rounded">App Entry</span>
                    </div>
                    <div class="p-4 space-y-3">
                        <p class="text-xs text-gray-600 mb-1">Se voc√™ colocar um arquivo <code>__main__.py</code> dentro de um pacote, pode executar o diret√≥rio inteiro (ou zip) como se fosse um execut√°vel.</p>
                        
                        <div class="text-xs font-mono bg-gray-100 p-2 rounded mb-2">
                            mypipeline/<br>
                            ‚îú‚îÄ‚îÄ __init__.py<br>
                            ‚îú‚îÄ‚îÄ extract.py<br>
                            ‚îî‚îÄ‚îÄ <strong class="text-yellow-600">__main__.py</strong>
                        </div>

                        <pre><code class="language-python"># mypipeline/__main__.py
from .extract import run_extraction

if __name__ == "__main__":
    print("Running pipeline package...")
    run_extraction()

# Execu√ß√£o no terminal:
# $ python -m mypipeline
# OU
# $ python mypipeline/</code></pre>
                    </div>
                </section>

                <!-- __FILE__ QUIRKS -->
                <section class="card bg-white border rounded-lg overflow-hidden">
                    <div class="bg-slate-800 text-white px-4 py-2 flex justify-between items-center">
                        <h2 class="font-bold text-sm uppercase">6. Onde estou? (__file__)</h2>
                        <span class="text-xs bg-slate-700 px-2 rounded">Paths</span>
                    </div>
                    <div class="p-4 space-y-3">
                        <p class="text-xs text-gray-600 mb-1">Usar <code>__file__</code> para achar config files relativos ao script.</p>
                        <pre><code class="language-python">from pathlib import Path

# Caminho absoluto deste arquivo
THIS_FILE = Path(__file__).resolve()

# Diret√≥rio pai (root do projeto)
PROJECT_ROOT = THIS_FILE.parent

# Config relativa segura
CONFIG_PATH = PROJECT_ROOT / "configs" / "prod.yaml"</code></pre>
                        <div class="text-xs text-gray-500 mt-1 italic">Nota: <code>__file__</code> n√£o existe no REPL interativo.</div>
                    </div>
                </section>

            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-8 pt-4 border-t border-gray-200 text-center text-xs text-gray-500">
            <p><strong>Pro Tip:</strong> Evite l√≥gica pesada no escopo global (fora de fun√ß√µes/classes). Isso desacelera o tempo de importa√ß√£o e dificulta testes unit√°rios.</p>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
</body>
</html>
